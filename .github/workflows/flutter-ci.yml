name: Flutter CI & Pgyer Upload

on:
  push:
    branches:
      - 'master'  # ä»»æ„åˆ†æ”¯ push éƒ½è§¦å‘

jobs:
  build_and_upload:
    runs-on: ubuntu-latest

    steps:
      # 1ï¸âƒ£ æ‹‰å–ä»£ç 
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2ï¸âƒ£ å®‰è£… Flutter
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.32.8"  # æ›¿æ¢ä¸ºä½ çš„ Flutter ç‰ˆæœ¬
          android-license: true   # è‡ªåŠ¨æ¥å— Android SDK licenses


      # 4ï¸âƒ£ å®‰è£… jq ç”¨äºè§£æ JSON
      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      # 5ï¸âƒ£ è·å–ä¾èµ–
      - name: Install dependencies
        run: flutter pub get

      # 6ï¸âƒ£ åˆ†æä»£ç 
      - name: Run flutter analyze
        run: flutter analyze || echo "Analyze finished with warnings/errors"

      # 7ï¸âƒ£ è·‘æµ‹è¯•
#      - name: Run flutter test
#        run: flutter test || echo "Tests finished with failures"

      # 8ï¸âƒ£ æ‰“åŒ… release APK
      - name: Build release APK
        run: |
          echo "Building release APK..."
          flutter build apk --release
          ls -l build/app/outputs/flutter-apk/

      # 9ï¸âƒ£ æ£€æŸ¥ APK æ˜¯å¦ç”Ÿæˆ
      - name: Check APK exists
        run: |
          if [ ! -f build/app/outputs/flutter-apk/app-release.apk ]; then
            echo "APK not found! Build failed."
            exit 1
          fi

      # ğŸ”Ÿ ä¸Šä¼ åˆ°è’²å…¬è‹±
      - name: Upload to Pgyer
        id: upload
        shell: bash
        env:
          PGY_API_KEY: ${{ secrets.PGY_API_KEY }}
          PGY_USER_KEY: ${{ secrets.PGY_USER_KEY }}
        run: |
          APK_PATH="build/app/outputs/flutter-apk/app-release.apk"

          if [ ! -f "$APK_PATH" ]; then
            echo "APK not found at $APK_PATH"
            exit 1
          fi

          echo "Uploading APK to Pgyer..."
          response=$(curl -s -F "file=@$APK_PATH" \
                            -F "_api_key=$PGY_API_KEY" \
                            -F "uKey=$PGY_USER_KEY" \
                            https://www.pgyer.com/apiv2/app/upload)

          echo "Response from Pgyer:"
          echo "$response"

          # æå– buildShortcutUrl
          if command -v jq >/dev/null 2>&1; then
            shortcut=$(echo "$response" | jq -r '.data.buildShortcutUrl // empty')
          else
            shortcut=$(echo "$response" | sed -n 's/.*"buildShortcutUrl":"\([^"]*\)".*/\1/p')
          fi

          if [ -n "$shortcut" ] && [ "$shortcut" != "null" ]; then
            app_url="https://www.pgyer.com/$shortcut"
            echo "APK uploaded successfully! Download URL: $app_url"
          else
            echo "Upload failed, please check the response above."
            app_url=""
          fi

          # è®¾ç½® step è¾“å‡º
          echo "app_url=$app_url" >> $GITHUB_OUTPUT

      - name: Send notification
        if: always()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.MAIL_USER }}   # ä½ çš„ Gmail é‚®ç®±
          password: ${{ secrets.MAIL_PASS }}   # Gmail åº”ç”¨ä¸“ç”¨å¯†ç 
          subject: "APK Upload Result"
          body: |
            APK Upload Finished!

            Result: ${{ steps.upload.outputs.app_url != '' && 'Success âœ…' || 'Failed âŒ' }}
            Download URL: ${{ steps.upload.outputs.app_url }}
          to: unaos@qq.com
          from: ${{ secrets.MAIL_USER }}       # å‘ä»¶äººé‚®ç®±
#      - name: Upload to Pgyer
#        shell: bash
#        env:
#          PGY_API_KEY: ${{ secrets.PGY_API_KEY }}
#          PGY_USER_KEY: ${{ secrets.PGY_USER_KEY }}
#        run: |
#          APK_PATH="build/app/outputs/flutter-apk/app-release.apk"
#
#          if [ ! -f "$APK_PATH" ]; then
#            echo "APK not found at $APK_PATH"
#            exit 1
#          fi
#
#          echo "Uploading APK to Pgyer..."
#          response=$(curl -s -F "file=@$APK_PATH" \
#                            -F "_api_key=$PGY_API_KEY" \
#                            -F "uKey=$PGY_USER_KEY" \
#                            https://www.pgyer.com/apiv2/app/upload)
#
#          echo "Response from Pgyer:"
#          echo "$response"
#
#          # æå–ä¸‹è½½åœ°å€
#          if command -v jq >/dev/null 2>&1; then
#            app_url=$(echo "$response" | jq -r '.data.downloadUrl // empty')
#          else
#            app_url=$(echo "$response" | sed -n 's/.*"downloadUrl":"\([^"]*\)".*/\1/p')
#          fi
#          # åˆ¤æ–­ä¸Šä¼ æ˜¯å¦æˆåŠŸ
#          if [ -n "$app_url" ] && [ "$app_url" != "null" ]; then
#            echo "APK uploaded successfully! Download URL: https://www.pgyer.com/$app_url"
#          else
#            echo "Upload failed, please check the response above."
#          fi
#
#      - name: Send notification
#        if: always()
#        uses: dawidd6/action-send-mail@v3
#        with:
#          server_address: smtp.gmail.com
#          server_port: 465
#          username: ${{ secrets.MAIL_USER }}   # ä½ çš„ Gmail é‚®ç®±
#          password: ${{ secrets.MAIL_PASS }}   # Gmail åº”ç”¨ä¸“ç”¨å¯†ç 
#          subject: "APK Upload Result"
#          body: |
#            APK uploaded successfully!
#            Download URL: ${{ steps.upload.outputs.app_url }}
#          to: unaos@qq.com
#          from: ${{ secrets.MAIL_USER }}       # å¿…é¡»æŒ‡å®šå‘ä»¶äººé‚®ç®±